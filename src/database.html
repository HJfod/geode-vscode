<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <style>
            a:focus,
            input:focus,
            select:focus,
            textarea:focus {
                outline: 1px solid -webkit-focus-ring-color;
                outline-offset: -1px
            }

            input {
                height: 27px;
                padding: 6px;
                border: solid 1px;
                font-size: 13px;
                font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
                color: var(--vscode-settings-textInputForeground);
                background: var(--vscode-settings-textInputBackground);
                border: 1px solid var(--vscode-settings-textInputBorder);
            }

            textarea {
                white-space: nowrap;
                padding: 4px, 4px;
                font-size: 13px;
                font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
                color: var(--vscode-settings-textInputForeground);
                background: var(--vscode-settings-textInputBackground);
                border: 1px solid var(--vscode-settings-textInputBorder);
            }

            button {
                color: var(--vscode-button-foreground);
                background-color: var(--vscode-button-background);
                border: solid 1px var(--vscode-contrastBorder);
                padding: 6px 14px;
            }

            button:hover {
                background-color: var(--vscode-button-hoverBackground);
            }

            button:focus {
                outline: 1px solid -webkit-focus-ring-color;
                outline-offset: 2px
            }

            button:active {
                outline: none;
            }

            select {
                width: 300px;
                height: 27px;
                font-size: 13px;
                font-family:sans-serif;
                color: var(--vscode-settings-dropdownForeground);
                background: var(--vscode-settings-dropdownBackground);
                border: 1px solid var(--vscode-settings-dropdownBorder);
            }

            hr {
                opacity: 20%
            }

            html {
                height: 100%;
            }

            body {
                display: flex;
                align-items: stretch;
                flex-direction: column;
                height: 100%;
            }

            main {
                display: grid;
                gap: 1rem;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                grid-auto-rows: 150px;
                overflow: auto;
                align-self: strech;
                align-items: center;
            }

            article {
                display: flex;
                flex-direction: column;
                width: 150px;
                height: 150px;
                transition-duration: .5s;
            }

            article p {
                word-break: break-all;
                max-width: 150px;
            }

            article img {
                min-height: 0;
                flex-grow: 1;
                align-self: center;
            }

            .loading-circle {
                display: block;
                border: 0.3rem solid var(--vscode-settings-textInputBackground);
                border-radius: 50%;
                border-top: 0.3rem solid var(--vscode-settings-textInputForeground);
                width: 2rem;
                height: 2rem;
                flex-grow: 1;
                animation: spin 2s linear infinite;
                align-self: center;
            }

            article.hidden {
                display: none;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

    </head>
    <body>
        <header>
            <p>DATABASE_INFO</p>

            <select id="select-source">
                <option value="all">All</option>
                <option value="sprites">Standalone</option>
                DATABASE_OPTIONS
            </select>

            <p>Search:</p>
            <input id="search" type="search">
            <p id="search-count">Found my balls lmao</p>

            <hr>
        </header>

        <main></main>

        <script>
            (function() {

                const vscode = acquireVsCodeApi();
                const content = document.querySelector('main');
                const select = document.getElementById('select-source');
                const search = document.getElementById('search');
                const searchCount = document.getElementById('search-count');
                let dataCache = [];

                const observer = new IntersectionObserver(
                    (entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                fetchImage(entry.target);
                            } else {
                                unloadImage(entry.target);
                            }
                        });
                    }, {
                        root: content,
                        threshold: 0.5
                    }
                );

                select.addEventListener('change', _ => {
                    updateState();
                });

                search.addEventListener('input', _ => {
                    updateSearch();
                });

                function addLoadingCircle(article) {
                    if (!article.querySelector('.loading-circle')) {
                        const circle = document.createElement('div');
                        circle.classList.add('loading-circle');
                        article.insertBefore(circle, article.querySelector('img'));
                    }
                }

                function fetchImage(article) {
                    addLoadingCircle(article);
                    vscode.postMessage({
                        command: 'load-image',
                        path: article.getAttribute('img-path'),
                        element: article.getAttribute('id')
                    });
                }

                function unloadImage(article) {
                    const img = article.querySelector('img');
                    img.src = '';
                    article.querySelector(".loading-circle")?.remove();
                }

                function setImage(article, data) {
                    const img = article.querySelector('img');
                    img.src = `data:image/png;base64,${data}`;
                    article.querySelector(".loading-circle")?.remove();
                }
        
                function updateState() {
                    if (select.value.startsWith('sheet:')) {
                        vscode.postMessage({
                            command: 'request-sheet',
                            sheet: select.value.substring(6)
                        });
                    } else {
                        vscode.postMessage({
                            command: `request-${select.value}`
                        });
                    }
                }

                function filterSearch(spr) {
                    return spr.name.replace(/\s/g, '').toLowerCase().includes(
                        search.value.replace(/\s/g, '').toLowerCase()
                    );
                }

                function updateSearch() {
                    const show = dataCache.filter(filterSearch);
                    show.forEach(spr => {
                        document.getElementById(spr.name).classList.remove('hidden');
                    });
                    dataCache.filter(e => !filterSearch(e)).forEach(spr => {
                        document.getElementById(spr.name).classList.add('hidden');
                    });
                    searchCount.innerHTML = `Found ${show.length} sprites`;
                }

                function updateData(data = null) {
                    content.innerHTML = '';
                    if (data) {
                        dataCache = data;
                    } else {
                        data = dataCache;
                    }
                    data.forEach(spr => {
                        const article = document.createElement('article');
                        article.setAttribute('img-path', spr.path);
                        article.setAttribute('id', spr.name);
                        article.innerHTML = `
                            <img>
                            <p>${spr.name}</p>
                            <button>Use</button>
                        `;
                        observer.observe(article);
                        content.appendChild(article);
                    });
                    updateSearch();
                }

                window.addEventListener('message', e => {
                    const message = e.data;
                    switch (message.command) {
                        case 'update': {
                            updateData(message.data);
                        } break;

                        case 'image': {
                            setImage(document.getElementById(message.element), message.data);
                        } break;
                    }
                });

                vscode.postMessage({
                    command: "request-all"
                });

            }())
        </script>
    </body>
</html>
